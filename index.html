<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MiniCRM Mobile v2 ‚Äî Android</title>
<meta name="theme-color" content="#0b0f14" />
<style>
:root{
  --bg:#0b0f14; --panel:#101621; --soft:#0e141d; --glass:rgba(255,255,255,.05);
  --border:#1b2533; --text:#e7eef7; --muted:#9aa7bb; --accent:#19c37d; --danger:#ff5d5d; --warn:#ffb020;
  --radius:16px; --shadow:0 8px 28px rgba(0,0,0,.4);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:linear-gradient(180deg,var(--bg),#0a0e13 60%,#090d12);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto}

.header{position:sticky;top:0;z-index:20;display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(11,15,20,.95),rgba(11,15,20,.72));backdrop-filter:saturate(120%) blur(10px)}
.brand{display:flex;align-items:center;gap:10px}
.brand .dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#42ffb7,var(--accent));box-shadow:0 0 16px var(--accent)}
.brand h1{margin:0;font-weight:600;font-size:16px}
.header .right{margin-left:auto;display:flex;gap:8px;align-items:center}
.select,.iconbtn{background:var(--soft);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:8px}
.iconbtn{background:var(--glass);color:var(--muted)}

.search{display:flex;gap:8px;width:100%}
.search input{flex:1;background:var(--soft);border:1px solid var(--border);border-radius:12px;color:var(--text);padding:12px}
.search input::placeholder{color:var(--muted)}
.badge{white-space:nowrap;border:1px dashed var(--border);padding:10px 12px;border-radius:12px;color:var(--muted)}

.tabs{position:sticky;top:64px;z-index:19;display:flex;gap:8px;overflow:auto;padding:8px 12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(13,18,26,.9),rgba(13,18,26,.6))}
.tab{flex:0 0 auto;padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:var(--glass);color:var(--muted)}
.tab.active{color:var(--text);border-color:rgba(25,195,125,.35);background:linear-gradient(180deg,rgba(25,195,125,.14),rgba(25,195,125,.08));box-shadow:0 4px 18px rgba(25,195,125,.16)}

.pages{position:relative}
.page{display:none;min-height:calc(100dvh - 180px);padding:14px}
.page.active{display:block;animation:fade .18s}
@keyframes fade{from{opacity:.5;transform:translateY(4px)}to{opacity:1;transform:none}}

.card{position:relative;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;margin:10px 0}
.card .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.card .title{font-weight:700}
.card .muted{color:var(--muted)}
.card::after{content:"";position:absolute;inset:2px;border-radius:calc(var(--radius) - 2px);pointer-events:none;opacity:.75}
.card.glow-red::after{box-shadow:inset 0 0 24px rgba(255,93,93,.45), inset 0 0 60px rgba(255,93,93,.2)}
.card.glow-green::after{box-shadow:inset 0 0 24px rgba(25,195,125,.42), inset 0 0 60px rgba(25,195,125,.18)}
.card.dim-done{opacity:.75;filter:saturate(.85)}

.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.chip{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid var(--border);background:var(--glass);color:var(--muted)}
.chip.ok{color:#b8f7d9;border-color:rgba(25,195,125,.4)}
.chip.warn{color:#ffe0ad;border-color:rgba(255,176,32,.4)}
.chip.bad{color:#ffb8b8;border-color:rgba(255,93,93,.4)}

.actions{display:flex;gap:8px;margin-top:10px}
.btn{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);text-align:center}
.btn.primary{background:linear-gradient(180deg,#1dda8a,#19c37d);border-color:#19c37d;color:#062e1e;font-weight:800}
.btn.danger{background:linear-gradient(180deg,#ff7b7b,#ff5d5d);border-color:#ff5d5d;color:#2b0707;font-weight:800}
.btn.ghost{background:var(--soft)}
.btn.link{background:var(--glass)}

.form{display:grid;gap:10px}
.field{display:grid;gap:6px}
.field label{font-size:13px;color:var(--muted)}
.field input,.field textarea,.field select{padding:12px;background:var(--soft);border:1px solid var(--border);border-radius:12px;color:var(--text);outline:none}
.field textarea{min-height:80px;resize:vertical}

.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.kpi{background:linear-gradient(180deg,rgba(25,195,125,.12),rgba(25,195,125,.04));border:1px solid rgba(25,195,125,.35);border-radius:14px;padding:12px}
.kpi h3{margin:0 0 6px 0;font-size:13px;color:var(--muted)}
.kpi b{font-size:18px}

.navbar{position:sticky;bottom:0;z-index:18;border-top:1px solid var(--border);padding:10px;background:linear-gradient(0deg,rgba(9,12,16,.95),rgba(9,12,16,.75));backdrop-filter:blur(8px)}
.navrow{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.navbtn{padding:10px;border-radius:12px;border:1px solid var(--border);background:var(--glass);color:var(--muted)}
.navbtn.active{color:var(--text);border-color:rgba(25,195,125,.35);box-shadow:0 4px 18px rgba(25,195,125,.15)}

.stars{display:flex;gap:6px}
.star{font-size:20px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.4))}
.star.filled{color:#ffd45b}

.toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%);background:#111;color:#fff;border:1px solid #333;padding:10px 12px;border-radius:10px;opacity:0;transition:.2s;pointer-events:none}
.toast.show{opacity:1}

.banner{position:sticky;top:108px;z-index:17;padding:8px 12px;border-bottom:1px solid rgba(25,195,125,.35);display:none}
.banner.ok{background:linear-gradient(90deg,rgba(25,195,125,.16),rgba(25,195,125,.08))}
.banner.warn{background:linear-gradient(90deg,rgba(255,176,32,.18),rgba(255,176,32,.06));border-color:rgba(255,176,32,.45)}
.banner.block{background:linear-gradient(90deg,rgba(255,93,93,.18),rgba(255,93,93,.06));border-color:rgba(255,93,93,.45)}

.blocker{position:fixed;inset:0;background:rgba(11,15,20,.88);backdrop-filter:blur(4px);display:none;z-index:50;align-items:center;justify-content:center}
.blocker .modal{max-width:520px;margin:16px;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}

.logo{display:flex;align-items:center;gap:12px}
.logo .mark{width:36px;height:36px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#42ffb7,var(--accent));box-shadow:0 0 24px rgba(25,195,125,.45)}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.paygrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.paybtn{padding:12px;border-radius:12px;border:1px dashed var(--border);background:var(--glass);text-align:center}
.small{font-size:12px;color:var(--muted)}
.phone{color:#b8f7d9;text-decoration:none}

</style>
</head>
<body>
  <div class="header">
    <div class="brand"><div class="dot"></div><h1>MiniCRM v2 ‚Äî –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è</h1></div>
    <div class="right">
      <select id="profile" class="select" title="–ü—Ä–æ—Ñ–∏–ª—å"></select>
      <button id="add-profile" class="iconbtn" title="–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">Ôºã</button>
    </div>
  </div>

  <div class="header" style="gap:0;padding-top:0">
    <div class="search" style="width:100%">
      <input id="q" placeholder="–ü–æ–∏—Å–∫: –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –º–æ–¥–µ–ª—å, #ID‚Ä¶ (–ø–æ –±—É–∫–≤–∞–º/—Ü–∏—Ñ—Ä–∞–º)" autocomplete="off" />
      <div class="badge" id="stat">0 –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button>
    <button class="tab" data-page="debts">–ü—Ä–æ—Å—Ä–æ—á–∫–∞</button>
    <button class="tab" data-page="work">–í —Ä–∞–±–æ—Ç–µ</button>
    <button class="tab" data-page="done">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
    <button class="tab" data-page="edit">–ù–æ–≤—ã–π/–ü—Ä–∞–≤–∫–∞</button>
    <button class="tab" data-page="view">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
    <button class="tab" data-page="accounts">–ê–∫–∫–∞—É–Ω—Ç—ã</button>
    <button class="tab" data-page="about">–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</button>
  </div>

  <div class="banner" id="lic-banner"></div>

  <div class="pages" id="pages">
    <section class="page active" id="page-home">
      <div class="kpis" id="home-kpis"></div>
      <div id="home-list"></div>
    </section>

    <section class="page" id="page-debts">
      <div id="debts-summary"></div>
      <div id="debts-list"></div>
    </section>

    <section class="page" id="page-work"><div id="work-list"></div></section>
    <section class="page" id="page-done"><div id="done-list"></div></section>

    <section class="page" id="page-edit">
      <form class="form" id="form">
        <input type="hidden" id="f-id" />
        <div class="field"><label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label><input id="f-name" required /></div>
        <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="f-phone" inputmode="tel" placeholder="+7‚Ä¶" /></div>
        <div class="field"><label>–ú–æ–¥–µ–ª—å –∞–ø–ø–∞—Ä–∞—Ç–∞</label><input id="f-device" /></div>
        <div class="field"><label>–ü—Ä–æ–±–ª–µ–º–∞</label><textarea id="f-issue"></textarea></div>

        <div class="field"><label>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã ‚ÇΩ</label><input id="f-labor" type="number" inputmode="numeric" value="0" /></div>
        <div class="field"><label>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—á–∞—Å—Ç–µ–π ‚ÇΩ</label><input id="f-parts" type="number" inputmode="numeric" value="0" /></div>
        <div class="field"><label>–û–ø–ª–∞—á–µ–Ω–æ ‚ÇΩ</label><input id="f-paid" type="number" inputmode="numeric" value="0" /></div>
        <div class="field"><label>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã</label><input id="f-due" type="date" /></div>
        <div class="field"><label>–°—Ç–∞—Ç—É—Å</label>
          <select id="f-status">
            <option value="work">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
          </select>
        </div>
        <div class="field"><label>–ó–∞–º–µ—Ç–∫–∞ –º–∞—Å—Ç–µ—Ä–∞</label><textarea id="f-notes"></textarea></div>

        <div class="field"><label>–†–µ–π—Ç–∏–Ω–≥ –∫–ª–∏–µ–Ω—Ç–∞</label><div class="stars" id="f-stars"></div><div class="small">–∫–æ—Å–Ω–∏—Å—å –Ω—É–∂–Ω–æ–π –∑–≤–µ–∑–¥—ã</div></div>

        <div class="actions">
          <button type="button" class="btn ghost" id="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn primary" id="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <button type="button" class="btn danger" id="btn-delete" style="margin-top:6px">–£–¥–∞–ª–∏—Ç—å</button>
      </form>
    </section>

    <section class="page" id="page-view"><div id="view-wrap"></div></section>

    <section class="page" id="page-accounts">
      <div class="card">
        <div class="title">–õ–∏—Ü–µ–Ω–∑–∏—è</div>
        <div class="small" id="acc-lic-state">‚Äî</div>
        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="acc-check-lic">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–Ω–ª–∞–π–Ω</button>
          <button class="btn" id="acc-disable-lic">–û—Ç–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
        </div>
      </div>
      <div class="card">
        <div class="title">–ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø–ª–∞—Ç—ã (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)</div>
        <div class="small">1) –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ ‚Üí 2) –û–ø–ª–∞—Ç–∏—Ç–µ ‚Üí 3) –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥/TxID ‚Üí 4) –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—É—é –ª–∏—Ü–µ–Ω–∑–∏—é (JSON) ‚Üí 5) –ö–ª–∏–µ–Ω—Ç –í–ï–†–ò–§–ò–¶–ò–†–£–ï–¢ –ø–æ–¥–ø–∏—Å—å –ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–æ–º –∏ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç —Å—Ä–æ–∫.</div>
        <div class="grid2" style="margin-top:8px">
          <select id="plan" class="select">
            <option value="P1M">1 –º–µ—Å—è—Ü</option>
            <option value="P3M">3 –º–µ—Å—è—Ü–∞</option>
            <option value="P12M">12 –º–µ—Å—è—Ü–µ–≤</option>
          </select>
          <button class="btn primary" id="pay-open">–û–ø–ª–∞—Ç–∏—Ç—å</button>
        </div>
        <div class="grid2" style="margin-top:8px">
          <input id="pay-proof" placeholder="TxID/–ö–æ–¥ –æ—Ç –±–∞–Ω–∫–∞" />
          <button class="btn" id="redeem">–ü–æ–ª—É—á–∏—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é</button>
        </div>
        <div class="small" id="redeem-msg" style="margin-top:6px">‚Äî</div>
        <div class="grid2" style="margin-top:8px">
          <input id="lic-json" placeholder='–í—Å—Ç–∞–≤—å—Ç–µ JSON {"key","validUntil","sig"}' />
          <button class="btn" id="apply-lic">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å / –ü—Ä–æ–¥–ª–∏—Ç—å</button>
        </div>
      </div>
      <div class="card">
        <div class="title">–ö–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞ (–æ—Ñ–ª–∞–π–Ω)</div>
        <div class="grid2" style="margin-top:8px">
          <input id="acc-access-code" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 19801980" />
          <button class="btn" id="acc-apply-code">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="small">–ö–æ–¥ –¥–∞—ë—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ñ–ª–∞–π–Ω‚Äë–¥–æ—Å—Ç—É–ø –∏ <b>–Ω–µ –º–æ–∂–µ—Ç</b> –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å –¥–æ–ª—å—à–µ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ —Å—Ä–æ–∫–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å—Ç—Ä–æ–µ–Ω–∞.</div>
      </div>
      <div class="card">
        <div class="title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div id="acc-users" class="form"></div>
        <div class="actions"><button class="btn" id="acc-add-user">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button></div>
      </div>
      <div class="card">
        <div class="title">–ë—ç–∫–∞–ø / –æ–±–º–µ–Ω / —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</div>
        <div class="grid2" style="margin-top:8px">
          <button class="btn" id="acc-export-json">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
          <label class="btn" style="text-align:center;cursor:pointer"><input type="file" id="acc-import-json" accept="application/json" style="display:none">–ò–º–ø–æ—Ä—Ç JSON</label>
          <button class="btn" id="acc-share">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
          <button class="btn" id="acc-download">–°–∫–∞—á–∞—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
        </div>
        <div class="small" style="margin-top:6px">–û–Ω–ª–∞–π–Ω‚Äë—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –≤–∞—à–∏ Apps Script/Drive/Dropbox/OneDrive —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö <code>syncPull()</code>/<code>syncPush()</code> (–Ω–∏–∂–µ –≤ –∫–æ–¥–µ –æ—Ç–º–µ—á–µ–Ω–æ TODO).</div>
      </div>
    </section>

    <section class="page" id="page-about">
      <div class="card">
        <div class="logo"><div class="mark"></div>
          <div>
            <div class="title">–£–≥—Ä–∞–†–µ–º–ö–æ–º–ø ‚Äî MiniCRM v2</div>
            <div class="small">Android‚Äëfriendly, –æ—Ñ–ª–∞–π–Ω/–æ–Ω–ª–∞–π–Ω, –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å—å—é —Å–µ—Ä–≤–µ—Ä–∞</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="title">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</div>
        <ul class="small">
          <li>–ö–∞—Ä—Ç–æ—á–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤, –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (–∫—Ä–∞—Å–Ω—ã–π –¥–æ–ª–∂–Ω–∏–∫, –∑–µ–ª—ë–Ω—ã–π –≤ —Ä–∞–±–æ—Ç–µ, –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é)</li>
          <li>–°—Ç—Ä–æ–∫–∞ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ¬´–ü—Ä–æ—Å—Ä–æ—á–∫–∞: N –¥–Ω–µ–π¬ª, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ–ª–≥</li>
          <li>–î–∞—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´2 –Ω–æ—è–±—Ä—è –≤—Å 2025 –≥–æ–¥–∞¬ª</li>
          <li>–ü–æ–∏—Å–∫ –ø–æ –±—É–∫–≤–∞–º/—Ü–∏—Ñ—Ä–∞–º: –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –º–æ–¥–µ–ª—å, #ID</li>
          <li>–ê–∫–∫–∞—É–Ω—Ç—ã: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –ª–∏—Ü–µ–Ω–∑–∏–∏, –∫–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞</li>
          <li>–≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç/—à–∞—Ä–∏–Ω–≥, –∑–∞–¥–µ–ª –ø–æ–¥ –æ–Ω–ª–∞–π‚Äë—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é</li>
        </ul>
      </div>
    </section>
  </div>

  <div class="navbar" id="navbar">
    <div class="navrow">
      <button class="navbtn active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button>
      <button class="navbtn" data-page="debts">–ü—Ä–æ—Å—Ä–æ—á–∫–∞</button>
      <button class="navbtn" data-page="work">–í —Ä–∞–±–æ—Ç–µ</button>
      <button class="navbtn" data-page="edit">–ù–æ–≤—ã–π</button>
      <button class="navbtn" data-page="about">–û –ø—Ä–æ–≥—Ä.</button>
    </div>
  </div>

  <div class="toast" id="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

  <div class="blocker" id="blocker">
    <div class="modal">
      <div class="title">–î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</div>
      <div class="small" id="blocker-msg" style="margin:8px 0 12px">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏—Å—Ç—ë–∫.</div>
      <div class="actions">
        <button class="btn primary" data-act="open-accounts">–ö –ª–∏—Ü–µ–Ω–∑–∏–∏</button>
        <button class="btn" data-act="open-about">–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</button>
      </div>
    </div>
  </div>

<script>
// ========= –ú–∏–Ω–∏‚Äëinfra =========
const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const byId = id => document.getElementById(id);
const on  = (el,ev,fn,opts)=> el && el.addEventListener(ev,fn,opts);
const fmt = n => new Intl.NumberFormat('ru-RU').format(Math.round(Number(n||0)));
const money = n => fmt(n)+' ‚ÇΩ';
const days = ms => Math.ceil(ms/86400000);
const nowId = ()=>'#'+Math.floor(100000+Math.random()*899999);
const strip = s => (s==null?'':String(s)).toLowerCase().replace(/[\s\u00A0\-\u2010\u2011()]/g,'');
function ruDateLong(ts){ const d=new Date(ts); const wd=['–≤—Å','–ø–Ω','–≤—Ç','—Å—Ä','—á—Ç','–ø—Ç','—Å–±'][d.getDay()]; const m=d.toLocaleDateString('ru-RU',{month:'long'});return `${d.getDate()} ${m} ${wd} ${d.getFullYear()} –≥–æ–¥–∞`; }
function toast(msg){ const t=byId('toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }

// ========= –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ –ø—Ä–æ—Ñ–∏–ª—è–º =========
const K = { base:'mcrm.v2', lic:'mcrm.lic.v2', users:'mcrm.users', session:'mcrm.ses', profiles:'mcrm.profiles', cur:'mcrm.cur' };
function dbKey(){ const cur=localStorage.getItem(K.cur)||'default'; return `${K.base}:${cur}`; }
const DB = { get(){ try{return JSON.parse(localStorage.getItem(dbKey()))||[]}catch(e){return[]} }, set(v){ localStorage.setItem(dbKey(), JSON.stringify(v||[])); } };
function ensureProfiles(){ let list=[]; try{ list=JSON.parse(localStorage.getItem(K.profiles)||'[]') }catch(e){} if(!Array.isArray(list)||!list.length){ list=['default']; localStorage.setItem(K.profiles, JSON.stringify(list)); localStorage.setItem(K.cur,'default'); } return list; }
function renderProfiles(){ const sel=byId('profile'); if(!sel) return; const list=ensureProfiles(); const cur=localStorage.getItem(K.cur)||'default'; sel.innerHTML=list.map(p=>`<option value="${p}" ${p===cur?'selected':''}>${p}</option>`).join(''); }

// ========= –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏/—Å–µ—Å—Å–∏—è =========
function usersKey(){ const cur=localStorage.getItem(K.cur)||'default'; return `${K.users}.${cur}`; }
function sessionKey(){ const cur=localStorage.getItem(K.cur)||'default'; return `${K.session}.${cur}`; }
async function sha256Hex(text){ const enc=new TextEncoder().encode(text); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
function loadUsers(){ try{ const a=JSON.parse(localStorage.getItem(usersKey())||'[]'); return Array.isArray(a)?a:[] }catch(e){return[]} }
function saveUsers(a){ localStorage.setItem(usersKey(), JSON.stringify(a||[])); }
function getCred(){ try{ const s=JSON.parse(sessionStorage.getItem(sessionKey())||'null'); return s&&s.ok?s:null }catch(e){return null} }
function setCred(s){ sessionStorage.setItem(sessionKey(), JSON.stringify(s)); }
function clearCred(){ sessionStorage.removeItem(sessionKey()); }
function canEdit(){ return state.auth.ok && (state.auth.role==='admin'||state.auth.role==='editor'); }
function canDelete(){ return state.auth.ok && state.auth.role==='admin'; }

// ========= –õ–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å—å—é =========
const LIC = { key:'mcrm.lic.v2' };
function licGet(){ try{ return JSON.parse(localStorage.getItem(LIC.key)) || { trialStart:null, validUntil:null, key:'', sig:'' } }catch(e){ return { trialStart:null, validUntil:null, key:'', sig:'' } }
}
function licSet(v){ localStorage.setItem(LIC.key, JSON.stringify(v)); }
const publicKeyPem = `-----BEGIN PUBLIC KEY-----\nMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE2Qd+Jp1rXyQqg0w9a0m5qgI0mQf+\nqkQ3z1b3m3Jv9T1b1i0e3Ck6e2Jq5p1wM9uI6O8sC6v2k7dB8v1ZQ5Ck1Q==\n-----END PUBLIC KEY-----`;
function pemToArray(pem){ const b64=pem.replace(/-----[^-]+-----/g,'').replace(/\s+/g,''); const raw=atob(b64); const arr=new Uint8Array(raw.length); for(let i=0;i<raw.length;i++)arr[i]=raw.charCodeAt(i); return arr.buffer; }
async function importKey(){ try{ return await crypto.subtle.importKey('spki', pemToArray(publicKeyPem), {name:'ECDSA',namedCurve:'P-256'}, true, ['verify']); }catch(e){ return null } }
async function verifySignature(payload, sigB64){ try{ const key=await importKey(); if(!key) return false; const enc=new TextEncoder().encode(payload); const sig=Uint8Array.from(atob(sigB64), c=>c.charCodeAt(0)); return await crypto.subtle.verify({name:'ECDSA', hash:'SHA-256'}, key, sig, enc); }catch(e){ return false } }
function licState(){ const l=licGet(); const now=Date.now(); let status='blocked', txt='–ù–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏', left=0; if(l.validUntil && l.validUntil>now){ status='licensed'; left=days(l.validUntil-now); txt='–õ–∏—Ü–µ–Ω–∑–∏—è –∞–∫—Ç–∏–≤–Ω–∞: –æ—Å—Ç–∞–ª–æ—Å—å '+left+' –¥.' } else if(l.trialStart && (l.trialStart+7*86400000)>now){ status='trial'; left=days(l.trialStart+7*86400000-now); txt='–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥: –æ—Å—Ç–∞–ª–æ—Å—å '+left+' –¥.' } else { status='blocked'; txt='–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.' } return {status, txt, left} }
function isAllowed(){ return licState().status!=='blocked' }
function startTrial(){ const l=licGet(); if(l.trialStart){ toast('–ü—Ä–æ–±–Ω—ã–π —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'); return; } l.trialStart=Date.now(); licSet(l); updateLicUI(); }
async function applyLicenseJSON(jsonStr){ try{ const data=JSON.parse(jsonStr); const {key, validUntil, sig}=data||{}; if(!key||!validUntil||!sig){ toast('–ù–µ–≤–µ—Ä–Ω—ã–π JSON –ª–∏—Ü–µ–Ω–∑–∏–∏'); return false; } const payload=JSON.stringify({key, validUntil}); const ok=await verifySignature(payload, sig); if(!ok){ toast('–ü–æ–¥–ø–∏—Å—å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞'); return false; } const l=licGet(); if(l.validUntil && validUntil<l.validUntil){ toast('–°–æ–∫—Ä–∞—Ç–∏—Ç—å —Å—Ä–æ–∫ –Ω–µ–ª—å–∑—è'); return false; } l.key=key; l.validUntil=validUntil; l.sig=sig; licSet(l); updateLicUI(); toast('–õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞'); return true; }catch(e){ toast('–û—à–∏–±–∫–∞ JSON'); return false } }
function applyAccessCode(code, daysLen=7){ if(!code||code.length<6){ toast('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥'); return false } const l=licGet(); const until=Date.now()+daysLen*86400000; if(l.validUntil && until>l.validUntil){ toast('–ö–æ–¥ –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –¥–æ–ª—å—à–µ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ'); return false } l.key=(l.key||'ACCESS')+'-LOCAL'; l.validUntil=Math.max(l.validUntil||0, until); licSet(l); updateLicUI(); toast('–ö–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω'); return true }
function disableLicense(){ const l=licGet(); l.validUntil=Date.now()-1000; licSet(l); updateLicUI(); }
function updateLicUI(){ const b=byId('lic-banner'); const st=licState(); if(b){ b.style.display='block'; b.textContent=st.txt; b.className='banner '+(st.status==='licensed'?'ok':st.status==='trial'?'warn':'block'); } const acc=byId('acc-lic-state'); if(acc) acc.textContent=st.txt; const blocker=byId('blocker'); const msg=byId('blocker-msg'); const must=!isAllowed()&&['about','accounts'].indexOf(state.page)===-1; if(blocker){ blocker.style.display=must?'flex':'none'; if(msg) msg.textContent=st.txt; } }

// ======= –ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø–ª–∞—Ç—ã (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å) =======
const PAY = { links: { P1M:'#', P3M:'#', P12M:'#' }, redeem: '/api/license/redeem' /* TODO: –∑–∞–º–µ–Ω–∏—Ç—å –≤–∞—à–∏–º Apps Script URL */ };
async function redeemLicense(){ const tx = byId('pay-proof')?.value?.trim(); const plan=byId('plan')?.value||'P1M'; const out = byId('redeem-msg'); if(!tx){ out.textContent='–í–≤–µ–¥–∏—Ç–µ TxID/–∫–æ–¥ –∏–∑ –±–∞–Ω–∫–∞'; return; } try{
    const mock = { key:'URK-'+plan+'-'+tx.slice(-6), validUntil: Date.now()+30*86400000, sig:'INVALID_SIG' };
    out.textContent='–õ–∏—Ü–µ–Ω–∑–∏—è –ø–æ–ª—É—á–µ–Ω–∞. –í—Å—Ç–∞–≤—å—Ç–µ JSON –Ω–∏–∂–µ –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ.';
    byId('lic-json').value=JSON.stringify(mock);
  }catch(e){ out.textContent='–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏'; }
}

// ========= –î–∞–Ω–Ω—ã–µ/–º–æ–¥–µ–ª—å =========
function compute(it){ const labor=+it.labor||0, parts=+it.parts||0, paid=+it.paid||0; const total=labor+parts; const debt=Math.max(0,total-paid); const dueAt= it.dueAt?+it.dueAt : (it.createdAt?+it.createdAt+3*86400000: Date.now()); const overdueDays=(debt>0 && Date.now()>dueAt)? days(Date.now()-dueAt):0; return {total,debt,dueAt,overdueDays}; }
function matchQuery(it,q){ if(!q) return true; const src=strip([it.name,it.phone,it.device,it.id].join(' ')); const qq=strip(q); return src.includes(qq)||src.startsWith(qq); }
function aggregate(list){ let totalDebt=0,totalPaid=0,totalSum=0,inWork=0,done=0, debtors=0; list.forEach(x=>{ const m=compute(x); totalDebt+=m.debt; totalPaid+=+x.paid||0; totalSum+=m.total; inWork+= x.status==='work'?1:0; done+= x.status==='done'?1:0; if(m.debt>0) debtors++; }); return {totalDebt,totalPaid,totalSum,inWork,done,debtors,count:list.length}; }

// ========= UI/State =========
let state={ page:'home', query:'', editId:null, viewId:null, stars:0, auth:{ok:false, role:'guest', name:'–ì–æ—Å—Ç—å'} };
let refs={};

function card(it){ const m=compute(it); const tel=(it.phone||'').replace(/[^\d+]/g,''); const glow = it.status==='done'? 'dim-done' : (m.debt>0? 'glow-red' : 'glow-green'); const overdueLine = m.debt>0? `‚Ä¢ –ü—Ä–æ—Å—Ä–æ—á–∫–∞: ${m.overdueDays} –¥–Ω.` : '‚Ä¢ –ë–µ–∑ –ø—Ä–æ—Å—Ä–æ—á–∫–∏'; const stars='‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.split('').map((s,i)=>`<span class="star ${i<(it.rating||0)?'filled':''}">‚òÖ</span>`).join(''); return `
  <div class="card ${glow}" data-id="${it.id}">
    <div class="row">
      <div class="title">${it.name} <span class="muted">${it.id}</span></div>
      <div class="stars" aria-hidden="true">${stars}</div>
    </div>
    <div class="row small" style="margin-top:6px">
      <a class="phone" href="tel:${tel}">üìû ${it.phone||''}</a>
      <span>‚Ä¢ ${it.device||''}</span>
      <span>${overdueLine}</span>
    </div>
    <div class="chips">
      <span class="chip">–û–±—Ä–∞—â–µ–Ω–∏–µ: ${ruDateLong(it.createdAt||Date.now())}</span>
      <span class="chip">–†–∞–±–æ—Ç–∞: ${money(it.labor||0)}</span>
      <span class="chip">–î–µ—Ç–∞–ª–∏: ${money(it.parts||0)}</span>
      <span class="chip"><b>–ò—Ç–æ–≥–æ: ${money(m.total)}</b></span>
      ${m.debt>0? `<span class="chip bad"><b>–î–æ–ª–≥: ${money(m.debt)}</b></span>`: `<span class="chip ok">–û–ø–ª–∞—á–µ–Ω–æ: ${money(it.paid||0)}</span>`}
      <span class="chip ${it.status==='done'?'ok':'warn'}">${it.status==='done'?'–ó–∞–≤–µ—Ä—à—ë–Ω':'–í —Ä–∞–±–æ—Ç–µ'}</span>
    </div>
    <div class="actions">
      <button class="btn" data-act="call">–í—ã–∑–≤–∞—Ç—å</button>
      <button class="btn" data-act="done">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      <button class="btn primary" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
  </div>`; }

function empty(msg){ return `<div class="card"><div class="muted">${msg}</div></div>`; }

function renderKpis(list){ const a=aggregate(list); const box=byId('home-kpis'); if(!box) return; box.innerHTML = `
  <div class="kpi"><h3>–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3><b>${a.count}</b><div class="small">–í —Ä–∞–±–æ—Ç–µ: ${a.inWork} ‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${a.done}</div></div>
  <div class="kpi"><h3>–§–∏–Ω–∞–Ω—Å—ã</h3><b>${money(a.totalPaid)} / ${money(a.totalSum)}</b><div class="small">–û–±—â–∏–π –¥–æ–ª–≥: <b style="color:var(--warn)">${money(a.totalDebt)}</b></div></div>`; }

function renderLists(){
  const all=DB.get();
  const filtered=all.filter(x=>matchQuery(x,state.query));
  const stat=byId('stat');
  const a=aggregate(filtered);
  if(stat) stat.textContent=`${a.count} ‚Ä¢ –ø—Ä–æ—Å—Ä–æ—á–∫–∞ ${a.debtors} ‚Ä¢ –≤ —Ä–∞–±–æ—Ç–µ ${a.inWork}`;
  renderKpis(filtered);
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: 1) –¥–æ–ª–∂–Ω–∏–∫–∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é –¥–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏, 2) –≤ —Ä–∞–±–æ—Ç–µ (—Å–≤–µ–∂–∏–µ), 3) –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ (—Å–≤–µ–∂–∏–µ)
  const sorted=[...filtered].sort((x,y)=>{
    const mx=compute(x), my=compute(y);
    const dx=mx.debt>0, dy=my.debt>0;
    if(dx!==dy) return (dy?1:0) - (dx?1:0); // –¥–æ–ª–∂–Ω–∏–∫–∏ –ø–µ—Ä–≤—ã–º–∏
    if(dx && dy){ // —Å—Ä–µ–¥–∏ –¥–æ–ª–∂–Ω–∏–∫–æ–≤ ‚Äî –ø–æ –¥–Ω—è–º –ø—Ä–æ—Å—Ä–æ—á–∫–∏
      if(my.overdueDays!==mx.overdueDays) return my.overdueDays - mx.overdueDays;
    }
    if(x.status!==y.status){ return x.status==='work' ? -1 : 1; }
    return (y.createdAt||0) - (x.createdAt||0);
  });
  const home=byId('home-list'); if(home) home.innerHTML = sorted.map(card).join('') || empty('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞.');
  const debtOnly=filtered.filter(x=>compute(x).debt>0);
  const debSum=byId('debts-summary'); if(debSum){ const sum=debtOnly.reduce((s,x)=>s+compute(x).debt,0); debSum.innerHTML=`<div class="card glow-red"><div class="title">–ü—Ä–æ—Å—Ä–æ—á–∫–∞ ‚Äî —Å–≤–æ–¥–∫–∞</div><div class="chips"><span class="chip bad">–í—Å–µ–≥–æ –¥–æ–ª–≥: ${money(sum)}</span><span class="chip">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${debtOnly.length}</span></div></div>`; }
  const dlist=byId('debts-list'); if(dlist) dlist.innerHTML = debtOnly.map(card).join('') || empty('–ù–µ—Ç –¥–æ–ª–∂–Ω–∏–∫–æ–≤ üéâ');
  const w=byId('work-list'); if(w) w.innerHTML = filtered.filter(x=>x.status==='work').map(card).join('') || empty('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞–±–æ—Ç');
  const dn=byId('done-list'); if(dn) dn.innerHTML = filtered.filter(x=>x.status==='done').map(card).join('') || empty('–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö');
}

function renderStars(el,val){ if(!el) return; el.innerHTML='‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.split('').map((s,i)=>`<span class="star ${i<val?'filled':''}" data-val="${i+1}">‚òÖ</span>`).join(''); }

function fillForm(id){
  const f={ id:byId('f-id'), name:byId('f-name'), phone:byId('f-phone'), device:byId('f-device'), issue:byId('f-issue'), labor:byId('f-labor'), parts:byId('f-parts'), paid:byId('f-paid'), status:byId('f-status'), notes:byId('f-notes'), due:byId('f-due') };
  const del=byId('btn-delete'); const starsEl=byId('f-stars');
  if(!id){ if(byId('form')) byId('form').reset(); state.stars=0; renderStars(starsEl,0); if(f.due) f.due.valueAsDate=new Date(Date.now()+3*86400000); if(del) del.style.display='none'; return; }
  const it=DB.get().find(x=>x.id===id); if(!it){ fillForm(null); return; }
  f.id.value=it.id; f.name.value=it.name||''; f.phone.value=it.phone||''; f.device.value=it.device||''; f.issue.value=it.issue||''; f.labor.value=it.labor||0; f.parts.value=it.parts||0; f.paid.value=it.paid||0; f.status.value=it.status||'work'; f.notes.value=it.notes||'';
  if(f.due && it.dueAt){ const d=new Date(it.dueAt); f.due.valueAsDate=new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
  state.stars=it.rating||0; renderStars(starsEl,state.stars); if(del) del.style.display='block';
}

function renderView(){ const r=byId('view-wrap'); if(!r) return; const it=DB.get().find(x=>x.id===state.viewId); if(!it){ r.innerHTML=empty('–ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; } const m=compute(it); const tel=(it.phone||'').replace(/[^\d+]/g,''); const stars='‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.split('').map((s,i)=>`<span class="star ${i<(it.rating||0)?'filled':''}">‚òÖ</span>`).join(''); const overdue = m.debt>0? `–ü—Ä–æ—Å—Ä–æ—á–∫–∞: ${m.overdueDays} –¥–Ω.` : '–ë–µ–∑ –ø—Ä–æ—Å—Ä–æ—á–∫–∏'; const glow = it.status==='done'? 'dim-done' : (m.debt>0? 'glow-red':'glow-green'); r.innerHTML = `
  <div class="card ${glow}">
    <div class="row"><div class="title">${it.name} <span class="muted">${it.id}</span></div><div class="stars" aria-hidden="true">${stars}</div></div>
    <div class="row small" style="margin-top:6px"><a class="phone" href="tel:${tel}">üìû ${it.phone||''}</a><span>‚Ä¢ ${it.device||''}</span><span>‚Ä¢ ${overdue}</span></div>
    <div class="chips" style="margin-top:6px">
      <span class="chip">–û–±—Ä–∞—â–µ–Ω–∏–µ: ${ruDateLong(it.createdAt||Date.now())}</span>
      <span class="chip">–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã: ${it.dueAt?ruDateLong(it.dueAt):'–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
      <span class="chip">–°—Ç–∞—Ç—É—Å: ${it.status==='done'?'–ó–∞–≤–µ—Ä—à—ë–Ω':'–í —Ä–∞–±–æ—Ç–µ'}</span>
      <span class="chip">–†–∞–±–æ—Ç–∞: ${money(it.labor||0)}</span>
      <span class="chip">–î–µ—Ç–∞–ª–∏: ${money(it.parts||0)}</span>
      <span class="chip"><b>–ò—Ç–æ–≥–æ: ${money(m.total)}</b></span>
      ${m.debt>0? `<span class="chip bad"><b>–î–æ–ª–≥: ${money(m.debt)}</b></span>`: `<span class="chip ok">–û–ø–ª–∞—á–µ–Ω–æ: ${money(it.paid||0)}</span>`}
    </div>
    ${it.issue?`<div class="small" style="margin-top:10px"><b>–ü—Ä–æ–±–ª–µ–º–∞:</b> ${it.issue}</div>`:''}
    ${it.notes?`<div class="small" style="margin-top:6px"><b>–ó–∞–º–µ—Ç–∫–∞ –º–∞—Å—Ç–µ—Ä–∞:</b> ${it.notes}</div>`:''}
    <div class="actions" style="margin-top:12px">
      <button class="btn" data-v="call">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
      <button class="btn" data-v="wa">WhatsApp</button>
      <button class="btn" data-v="copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª.</button>
    </div>
    <div class="actions" style="margin-top:8px">
      <button class="btn link" data-v="share">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      <button class="btn primary" data-v="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>`; }

function go(page){ if(page!=='about' && page!=='accounts' && !isAllowed()){ page='accounts'; }
  state.page=page; $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.page===page)); $$('.navbtn').forEach(b=>b.classList.toggle('active', b.dataset.page===page)); $$('.page').forEach(p=>p.classList.toggle('active', p.id===`page-${page}`)); renderLists(); if(page==='edit') fillForm(state.editId); if(page==='view') renderView(); if(page==='accounts') renderAccounts(); updateLicUI(); }

// ========= Accounts UI =========
function renderAccounts(){ const box=byId('acc-users'); if(!box) return; const list=loadUsers(); if(!state.auth.ok || state.auth.role!=='admin'){ box.innerHTML='<div class="small">–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.</div>'; return; } box.innerHTML = list.map(u=>`
  <div class="card" data-uid="${u.id}">
    <div class="grid2">
      <div class="field"><label>–ò–º—è</label><input value="${u.name}" data-f="name"></div>
      <div class="field"><label>–†–æ–ª—å</label><select data-f="role"><option value="admin" ${u.role==='admin'?'selected':''}>admin</option><option value="editor" ${u.role==='editor'?'selected':''}>editor</option><option value="guest" ${u.role==='guest'?'selected':''}>guest</option></select></div>
    </div>
    <div class="grid2" style="margin-top:6px">
      <input placeholder="–ù–æ–≤—ã–π –ü–ò–ù (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" data-f="pin" inputmode="numeric">
      <button class="btn" data-act="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div class="actions" style="margin-top:6px"><button class="btn danger" data-act="del">–£–¥–∞–ª–∏—Ç—å</button></div>
  </div>`).join('') || '<div class="small">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è¬ª.</div>';
  on(box,'click',async (e)=>{ const card=e.target.closest('.card'); if(!card) return; const id=card.dataset.uid; const act=e.target.closest('[data-act]')?.getAttribute('data-act'); let users=loadUsers(); const i=users.findIndex(x=>x.id===id); if(i<0)return; if(act==='save'){ const name=card.querySelector('[data-f="name"]').value.trim()||users[i].name; const role=card.querySelector('[data-f="role"]').value||users[i].role; const pin=card.querySelector('[data-f="pin"]').value.trim(); users[i].name=name; users[i].role=role; if(pin){ users[i].pinHash=await sha256Hex(pin); } saveUsers(users); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); }
    if(act==='del'){ if(users.length<=1){ toast('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ'); return;} users=users.filter(x=>x.id!==id); saveUsers(users); toast('–£–¥–∞–ª—ë–Ω'); renderAccounts(); }
  }); }
function addUserUI(){ if(!state.auth.ok||state.auth.role!=='admin'){ toast('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω'); return; } (async()=>{ const name=prompt('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:','–ù–æ–≤—ã–π')||'–ù–æ–≤—ã–π'; const role=prompt('–†–æ–ª—å (admin/editor/guest):','editor')||'editor'; const pin=prompt('–ü–ò–ù (4‚Äì32):','1234')||'1234'; if(pin.length<4||pin.length>32){ toast('–ü–ò–ù 4‚Äì32'); return; } const users=loadUsers(); users.push({id:'u-'+Date.now(), name, role:(['admin','editor','guest'].includes(role)?role:'editor'), pinHash: await sha256Hex(pin)}); saveUsers(users); toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω'); renderAccounts(); })(); }

// ========= Sync (–∑–∞–≥–ª—É—à–∫–∏ —Å TODO) =========
async function syncPull(){ /* TODO: fetch —Å –≤–∞—à–µ–≥–æ Apps Script/Drive API –∏ merge */ toast('Sync pull: TODO'); }
async function syncPush(){ /* TODO: –æ—Ç–ø—Ä–∞–≤–∫–∞ diff –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä */ toast('Sync push: TODO'); }

// ========= –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–º–∏–Ω–∏–º—É–º) =========
function ensureDefaultAdmin(){ let users=loadUsers(); if(!users.length){ users=[{id:'u-root', name:'–ê–¥–º–∏–Ω', role:'admin', pinHash:''}]; saveUsers(users); } }
async function promptLogin(){ const users=loadUsers(); if(!users.length){ ensureDefaultAdmin(); return promptLogin(); }
  const names=users.map((u,i)=>`${i+1}) ${u.name} [${u.role}]`).join('\n'); const idxStr=prompt('–í–æ–π—Ç–∏ –∫–∞–∫:\n'+names+'\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:','1'); const idx=Math.max(1,Math.min(users.length, parseInt(idxStr||'1',10)))-1; const u=users[idx]; const pin=prompt('–í–≤–µ–¥–∏—Ç–µ –ü–ò–ù –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ¬´'+u.name+'¬ª (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç–æ, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω):',''); if(u.pinHash){ const ok=(await sha256Hex(pin||''))===u.pinHash; if(!ok){ toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù'); return false; } }
  state.auth={ok:true, role:u.role, name:u.name, uid:u.id}; setCred(state.auth); toast('–í—Ö–æ–¥: '+u.name+' ['+u.role+']'); return true; }
function requireAuth(){ if(canEdit()) return true; toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return promptLogin(); }

// ========= Init / Handlers =========
async function init(){ refs={ pages:byId('pages'), tabs:byId('tabs'), navbar:byId('navbar'), q:byId('q') };
  // –ü—Ä–æ—Ñ–∏–ª–∏
  renderProfiles();
  on(byId('profile'),'change',e=>{ localStorage.setItem(K.cur,e.target.value); toast('–ü—Ä–æ—Ñ–∏–ª—å: '+e.target.value); state.auth={ok:false, role:'guest', name:'–ì–æ—Å—Ç—å'}; renderProfiles(); renderLists(); go('home'); });
  on(byId('add-profile'),'click',()=>{ const name=prompt('–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã):','user2'); if(!name) return; const list=ensureProfiles(); if(!list.includes(name)){ list.push(name); localStorage.setItem(K.profiles, JSON.stringify(list)); localStorage.setItem(K.cur,name); state.auth={ok:false, role:'guest', name:'–ì–æ—Å—Ç—å'}; renderProfiles(); toast('–î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–æ—Ñ–∏–ª—å '+name); go('home'); }});

  // –ü–æ–∏—Å–∫
  on(refs.q,'input',()=>{ state.query=refs.q.value.trim(); renderLists(); });

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è
  const navH=(e)=>{ const b=e.target.closest('[data-page]'); if(!b) return; const p=b.getAttribute('data-page'); if(p==='edit') state.editId=null; go(p); };
  on(refs.tabs,'click',navH); on(refs.navbar,'click',navH);

  // –°–≤–∞–π–ø—ã
  let touchX=null; const order=['home','debts','work','done','edit','view','accounts','about'];
  on(refs.pages,'touchstart',e=>{touchX=e.changedTouches[0].clientX});
  on(refs.pages,'touchend',e=>{ if(touchX==null) return; const dx=e.changedTouches[0].clientX-touchX; touchX=null; if(Math.abs(dx)<50) return; let i=order.indexOf(state.page); if(dx<0 && i<order.length-1) go(order[i+1]); if(dx>0 && i>0) go(order[i-1]); });

  // –ö–∞—Ä—Ç–æ—á–∫–∏
  on(refs.pages,'click',(e)=>{ const card=e.target.closest('.card'); if(!card) return; const id=card.dataset.id; if(!id) return;
    if(e.target.closest('[data-act="open"]')){ state.viewId=id; go('view'); return; }
    if(e.target.closest('[data-act="done"]')){
      if(!canEdit()){ requireAuth(); return; }
      const a=DB.get(); const i=a.findIndex(x=>x.id===id);
      if(i>-1){ a[i].status='done'; DB.set(a); toast('–û—Ç–º–µ—á–µ–Ω–æ ¬´–ó–∞–≤–µ—Ä—à—ë–Ω¬ª'); renderLists(); }
      return;
    }
    if(e.target.closest('[data-act="call"]')){
      const it=DB.get().find(x=>x.id===id); if(it){ location.href='tel:'+(it.phone||'').replace(/[^\d+]/g,''); }
      return;
    }
    if(!e.target.closest('.btn')){ state.viewId=id; go('view'); }
  });

  // –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ–π—Å—Ç–≤–∏—è
  on(byId('page-view'),'click',async (e)=>{ const act=e.target.closest('[data-v]')?.getAttribute('data-v'); if(!act) return; const it=DB.get().find(x=>x.id===state.viewId); if(!it) return; const m=compute(it); const tel=(it.phone||'').replace(/[^\d+]/g,''); if(act==='call') location.href='tel:'+tel; if(act==='wa') window.open('https://wa.me/'+tel.replace(/^\+/,''),'_blank'); if(act==='copy'){ try{ await navigator.clipboard.writeText(it.phone||''); toast('–¢–µ–ª–µ—Ñ–æ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); }catch(err){ toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); } } if(act==='share'){ const text=`${it.name} ${it.id}\n${it.device||''}\n–ò—Ç–æ–≥–æ: ${money(m.total)} ‚Ä¢ –û–ø–ª–∞—á–µ–Ω–æ: ${money(it.paid||0)} ‚Ä¢ –î–æ–ª–≥: ${money(m.debt)}\n–¢–µ–ª: ${it.phone||''}`; if(navigator.share){ try{ await navigator.share({title:'–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞', text}); }catch(_e){} } else { try{ await navigator.clipboard.writeText(text); toast('–î–µ—Ç–∞–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã'); }catch(_e){ toast('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é'); } } } if(act==='edit'){ state.editId=it.id; go('edit'); } });

  // –†–µ–π—Ç–∏–Ω–≥ (–≤ —Ñ–æ—Ä–º–µ)
  on(byId('page-edit'),'click',(e)=>{ const star=e.target.closest('#f-stars .star'); if(!star) return; state.stars=+star.dataset.val||0; renderStars(byId('f-stars'),state.stars); });

  // –§–æ—Ä–º–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
  on(byId('form'),'submit',(e)=>{ e.preventDefault(); if(!canEdit()){ const ok = requireAuth(); if(!ok) return; }
    const f={ id:byId('f-id'), name:byId('f-name'), phone:byId('f-phone'), device:byId('f-device'), issue:byId('f-issue'), labor:byId('f-labor'), parts:byId('f-parts'), paid:byId('f-paid'), status:byId('f-status'), notes:byId('f-notes'), due:byId('f-due') };
    const payload={ id:(f.id.value)||nowId(), name:(f.name.value||'').trim(), phone:(f.phone.value||'').trim(), device:(f.device.value||'').trim(), issue:(f.issue.value||'').trim(), labor:+(f.labor.value||0), parts:+(f.parts.value||0), paid:+(f.paid.value||0), status:f.status.value||'work', notes:(f.notes.value||'').trim(), rating:state.stars||0, createdAt: Date.now(), dueAt: f.due.valueAsDate? new Date(f.due.valueAsDate.getFullYear(), f.due.valueAsDate.getMonth(), f.due.valueAsDate.getDate()).getTime() : Date.now()+3*86400000 };
    const a=DB.get(); const i=a.findIndex(x=>x.id===payload.id); if(i>-1) a[i]={...a[i],...payload}; else a.unshift(payload); DB.set(a); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); state.editId=payload.id; state.viewId=payload.id; go('view'); });

  // –§–æ—Ä–º–∞ ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ/–æ—Ç–º–µ–Ω–∞
  on(byId('btn-delete'),'click',()=>{ if(!canDelete()){ toast('–£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É'); return; } const id=byId('f-id').value; if(!id) return; const a=DB.get().filter(x=>x.id!==id); DB.set(a); toast('–£–¥–∞–ª–µ–Ω–æ'); state.editId=null; go('home'); });
  on(byId('btn-cancel'),'click',()=>{ state.editId=null; go('home'); });

  // –ë–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫: –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  on(byId('blocker'),'click',(e)=>{ const act=e.target.closest('[data-act]')?.getAttribute('data-act'); if(!act) return; if(act==='open-accounts') go('accounts'); if(act==='open-about') go('about'); });

  // –ê–∫–∫–∞—É–Ω—Ç—ã: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  on(byId('acc-check-lic'),'click',()=>{ updateLicUI(); toast('–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω'); });
  on(byId('acc-disable-lic'),'click',()=>{ disableLicense(); toast('–î–æ—Å—Ç—É–ø –æ—Ç–∫–ª—é—á—ë–Ω'); });
  on(byId('pay-open'),'click',()=>{ const plan=byId('plan')?.value||'P1M'; const url=PAY.links[plan]; if(url && url!=='#'){ window.open(url,'_blank'); } else { toast('URL –æ–ø–ª–∞—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'); } });
  on(byId('redeem'),'click',redeemLicense);
  on(byId('apply-lic'),'click',()=>{ applyLicenseJSON(byId('lic-json').value.trim()); });
  on(byId('acc-apply-code'),'click',()=>{ applyAccessCode(byId('acc-access-code').value.trim(),7); });
  on(byId('acc-add-user'),'click',addUserUI);
  on(byId('acc-export-json'),'click',async()=>{ try{ const data=JSON.stringify(DB.get(),null,2); await navigator.clipboard.writeText(data); toast('–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä'); }catch(_){ toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); } });
  on(byId('acc-import-json'),'change',async(e)=>{ const f=e.target.files?.[0]; if(!f) return; const text=await f.text(); try{ const arr=JSON.parse(text); if(!Array.isArray(arr)) throw new Error('not array'); if(!confirm('–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –±–∞–∑—É –Ω–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—É—é?')) return; DB.set(arr); toast('–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω'); renderLists(); }catch(err){ toast('–û—à–∏–±–∫–∞ JSON'); } e.target.value=''; });
  on(byId('acc-share'),'click',async()=>{ const data=JSON.stringify(DB.get()); if(navigator.share){ try{ await navigator.share({title:'MiniCRM export', text:data}); toast('–ü–æ–¥–µ–ª–∏–ª–∏—Å—å'); }catch(_e){} } else { try{ await navigator.clipboard.writeText(data); toast('–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); }catch(_){ toast('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é'); } } });
  on(byId('acc-download'),'click',()=>{ const blob=new Blob([JSON.stringify(DB.get(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='minicrm-export.json'; a.click(); URL.revokeObjectURL(a.href); });

  // –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  ensureDefaultAdmin();
  renderStars(byId('f-stars'),0);
  updateLicUI();
  renderLists();
  // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –µ—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
  if(!isAllowed()) go('accounts');

  // –°–∞–º–æ—Ç–µ—Å—Ç—ã
  runTests();
}

document.addEventListener('DOMContentLoaded', init);

// ========= –¢–ï–°–¢–´ =========
function assert(cond, msg){ if(cond){ console.log('‚úÖ', msg); } else { console.error('‚ùå', msg); } }
function runTests(){
  try{
    // compute()
    const base={labor:2000, parts:1000, paid:500, createdAt:0, dueAt:Date.now()-5*86400000};
    const m=compute(base); assert(m.total===3000,'compute: total=3000'); assert(m.debt===2500,'compute: debt=2500'); assert(m.overdueDays>=5,'compute: overdue >=5');
    // matchQuery()
    const it={name:'–ò–≤–∞–Ω', phone:'+7 900 111-22-33', device:'iPhone', id:'#123'};
    assert(matchQuery(it,'–∏–≤') && matchQuery(it,'900111') && matchQuery(it,'#123'),'matchQuery: by name/phone/id');
    // sorting: debtor first
    const a=[
      {id:'#1', name:'A', labor:0, parts:0, paid:0, status:'work', createdAt:1}, // no debt
      {id:'#2', name:'B', labor:100, parts:0, paid:0, status:'work', createdAt:2, dueAt:Date.now()-86400000*3}, // debt 100, 3d overdue
      {id:'#3', name:'C', labor:100, parts:0, paid:50, status:'work', createdAt:3, dueAt:Date.now()-86400000*2} // debt 50, 2d overdue
    ];
    const sorted=[...a].sort((x,y)=>{
      const mx=compute(x), my=compute(y);
      const dx=mx.debt>0, dy=my.debt>0;
      if(dx!==dy) return (dy?1:0) - (dx?1:0);
      if(dx && dy){ if(my.overdueDays!==mx.overdueDays) return my.overdueDays - mx.overdueDays; }
      if(x.status!==y.status){ return x.status==='work' ? -1 : 1; }
      return (y.createdAt||0) - (x.createdAt||0);
    });
    assert(sorted[0].id==='#2' && sorted[1].id==='#3','sorting: debtors first by overdue');
    console.log('‚Äî –°–∞–º–æ—Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã ‚Äî');
  }catch(e){ console.error('–¢–µ—Å—Ç —É–ø–∞–ª:', e); }
}
</script>
</body>
</html>
